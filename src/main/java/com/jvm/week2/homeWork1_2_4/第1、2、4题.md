# 第一题

使用 GCLogAnalysis.java 自己演练一遍串行 / 并行 /CMS/G1 的案例。

>  GC图形化网址：https://gceasy.io/

### 模拟业务系统源码

```java
package com.jvm.week2;

import java.util.Random;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.LongAdder;
/*
演示GC日志生成与解读
*/
public class GCLogAnalysis {
    // 随机数; 记得这里可以设置随机数种子;
    private static Random random = new Random();
    public static void main(String[] args) {
        // 当前毫秒时间戳
        long startMillis = System.currentTimeMillis();
        // 持续运行毫秒数; 可根据需要进行修改
        long timeoutMillis = TimeUnit.SECONDS.toMillis(1);
        // 结束时间戳
        long endMillis = startMillis + timeoutMillis;
        LongAdder counter = new LongAdder();
        System.out.println("正在执行...");
        // 缓存一部分对象; 进入老年代
        int cacheSize = 2000;
        Object[] cachedGarbage = new Object[cacheSize];
        // 在此时间范围内,持续循环
        while (System.currentTimeMillis() < endMillis) {
            // 生成垃圾对象
            Object garbage = generateGarbage(100*1024);
            counter.increment();
            int randomIndex = random.nextInt(2 * cacheSize);
            if (randomIndex < cacheSize) {
                cachedGarbage[randomIndex] = garbage;
            }
        }
        System.out.println("执行结束!共生成对象次数:" + counter.longValue());
    }

    // 生成对象
    private static Object generateGarbage(int max) {
        int randomSize = random.nextInt(max);
        int type = randomSize % 4;
        Object result = null;
        switch (type) {
            case 0:
                result = new int[randomSize];
                break;
            case 1:
                result = new byte[randomSize];
                break;
            case 2:
                result = new double[randomSize];
                break;
            default:
                StringBuilder builder = new StringBuilder();
                String randomString = "randomString-Anything";
                while (builder.length() < randomSize) {
                    builder.append(randomString);
                    builder.append(max);
                    builder.append(randomSize);
                }
                result = builder.toString();
                break;
        }
        return result;
    }
}

```

### 打印GC日志命令(没配置GC策略)

如果你是jdk1.8那么需要编译这个GCLogAnalysis.java文件，然后运行下面的命令，jdk1.9往上就不需要了（奥对了，如果你是在命令行

的话，记得把代码第一行的包名去掉，用IDEA配置VM options就不用啦~）

#### 默认堆内存配置参数

如果你不配置任何参数`java GCLogAnalysis`，返回以下结果

```
正在执行...
执行结束!共生成对象次数:6421
```

它是有默认参数的，如果你运行内存16G，默认情况下JVM会使用1/4，也就是4G内存作为JVM的最大堆内存，如果当前的电脑运行内存小

于1G，那么就不会使用1/4，会使用1/2内存，0.5G作为JVM最大堆内存

如果你设置一些参数

#### 打印GC日志

`java -XX:+PrintGCDetails GCLogAnalysis`

[![OcvkKH.png](https://s1.ax1x.com/2022/05/14/OcvkKH.png)](https://imgtu.com/i/OcvkKH)

##### 日志

###### GC执行过程

```
正在执行...
[GC (Allocation Failure) [PSYoungGen: 64512K->10728K(75264K)] 64512K->21664K(247296K), 0.0042456 secs] [Times: user=0.06 sys=0.08, real=0.00 secs] 
[GC (Allocation Failure) [PSYoungGen: 74533K->10735K(139776K)] 85469K->41812K(311808K), 0.0058565 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 139759K->10748K(139776K)] 170836K->82664K(311808K), 0.0085015 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 139772K->10751K(268800K)] 211688K->125372K(440832K), 0.0099275 secs] [Times: user=0.06 sys=0.08, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 268799K->10744K(268800K)] 383420K->207149K(465920K), 0.0165233 secs] [Times: user=0.02 sys=0.06, real=0.02 secs] 
[Full GC (Ergonomics) [PSYoungGen: 10744K->0K(268800K)] [ParOldGen: 196405K->173283K(345600K)] 207149K->173283K(614400K), [Metaspace: 3409K->3409K(1056768K)], 0.0313202 secs] [Times: user=0.22 sys=0.02, real=0.03 secs] 
[GC (Allocation Failure) [PSYoungGen: 258048K->81376K(509440K)] 431331K->254659K(855040K), 0.0117195 secs] [Times: user=0.02 sys=0.11, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 509408K->107507K(587264K)] 682691K->351704K(932864K), 0.0320802 secs] [Times: user=0.24 sys=0.03, real=0.03 secs] 
[GC (Allocation Failure) [PSYoungGen: 587241K->161789K(831488K)] 831438K->443646K(1177088K), 0.0277443 secs] [Times: user=0.08 sys=0.23, real=0.03 secs] 
[Full GC (Ergonomics) [PSYoungGen: 161789K->0K(831488K)] [ParOldGen: 281856K->304021K(507392K)] 443646K->304021K(1338880K), [Metaspace: 3409K->3409K(1056768K)], 0.0474241 secs] [Times: user=0.25 sys=0.00, real=0.05 secs] 
[GC (Allocation Failure) [PSYoungGen: 669696K->174774K(876544K)] 973717K->478795K(1383936K), 0.0237431 secs] [Times: user=0.20 sys=0.11, real=0.02 secs] 
[GC (Allocation Failure) [PSYoungGen: 844470K->161777K(831488K)] 1148491K->575098K(1338880K), 0.0453382 secs] [Times: user=0.31 sys=0.05, real=0.05 secs] 
[Full GC (Ergonomics) [PSYoungGen: 161777K->0K(831488K)] [ParOldGen: 413320K->353015K(602112K)] 575098K->353015K(1433600K), [Metaspace: 3409K->3409K(1056768K)], 0.0531692 secs] [Times: user=0.42 sys=0.02, real=0.05 secs] 

```

###### 堆内存布局情况

程序运行完退出之前，堆内存布局情况

```
执行结束!共生成对象次数:12194
Heap
 PSYoungGen      total 831488K, used 88993K [0x000000076c000000, 0x00000007b6380000, 0x00000007c0000000)
  eden space 669696K, 13% used [0x000000076c000000,0x00000007716e8650,0x0000000794e00000)
  from space 161792K, 0% used [0x00000007a1800000,0x00000007a1800000,0x00000007ab600000)
  to   space 206848K, 0% used [0x0000000794e00000,0x0000000794e00000,0x00000007a1800000)
 ParOldGen       total 602112K, used 353015K [0x00000006c4000000, 0x00000006e8c00000, 0x000000076c000000)
  object space 602112K, 58% used [0x00000006c4000000,0x00000006d98bde90,0x00000006e8c00000)
 Metaspace       used 3642K, capacity 4540K, committed 4864K, reserved 1056768K
  class space    used 405K, capacity 428K, committed 512K, reserved 1048576K
```

#### 打印GC日志-指定堆内存

`-Xmx1g -Xms1g`

`java -XX:+PrintGCDetails -Xmx1g -Xms1g  GCLogAnalysis`

`-Xmx1g`最大堆内存`1g`，`-Xms 1g`堆内存起始值`1g`，配置成一致是个好习惯

你会发现GC会比之前更频繁了，因为之前是最大堆内存是`4g`(你的电脑运行内存的1/4)，现在变成1g肯定是更频繁，次数更多

##### GC执行过程

```
正在执行...
[GC (Allocation Failure) [PSYoungGen: 262144K->43510K(305664K)] 262144K->76138K(1005056K), 0.0113343 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 305654K->43519K(305664K)] 338282K->140500K(1005056K), 0.0160638 secs] [Times: user=0.02 sys=0.13, real=0.02 secs] 
[GC (Allocation Failure) [PSYoungGen: 305663K->43516K(305664K)] 402644K->217050K(1005056K), 0.0172734 secs] [Times: user=0.03 sys=0.09, real=0.02 secs] 
[GC (Allocation Failure) [PSYoungGen: 305660K->43509K(305664K)] 479194K->288376K(1005056K), 0.0163874 secs] [Times: user=0.03 sys=0.11, real=0.02 secs] 
[GC (Allocation Failure) [PSYoungGen: 305653K->43513K(305664K)] 550520K->368685K(1005056K), 0.0164813 secs] [Times: user=0.11 sys=0.05, real=0.02 secs] 
[GC (Allocation Failure) [PSYoungGen: 305657K->43511K(160256K)] 630829K->430100K(859648K), 0.0145927 secs] [Times: user=0.00 sys=0.00, real=0.02 secs] 
[GC (Allocation Failure) [PSYoungGen: 160247K->72263K(232960K)] 546836K->464665K(932352K), 0.0091830 secs] [Times: user=0.11 sys=0.03, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 188999K->91220K(232960K)] 581401K->491892K(932352K), 0.0122855 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 207912K->103177K(232960K)] 608584K->522364K(932352K), 0.0146505 secs] [Times: user=0.14 sys=0.02, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 219719K->77154K(232960K)] 638905K->551312K(932352K), 0.0148778 secs] [Times: user=0.08 sys=0.08, real=0.02 secs] 
[GC (Allocation Failure) [PSYoungGen: 193890K->36197K(232960K)] 668048K->579413K(932352K), 0.0132979 secs] [Times: user=0.06 sys=0.08, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 152933K->38776K(232960K)] 696149K->613105K(932352K), 0.0087953 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 155512K->41395K(232960K)] 729841K->651504K(932352K), 0.0098454 secs] [Times: user=0.11 sys=0.05, real=0.01 secs] 
[Full GC (Ergonomics) [PSYoungGen: 41395K->0K(232960K)] [ParOldGen: 610109K->324610K(699392K)] 651504K->324610K(932352K), [Metaspace: 3409K->3409K(1056768K)], 0.0485191 secs] [Times: user=0.39 sys=0.00, real=0.05 secs] 
[GC (Allocation Failure) [PSYoungGen: 116443K->35036K(232960K)] 441053K->359646K(932352K), 0.0045125 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[GC (Allocation Failure) [PSYoungGen: 151772K->36742K(232960K)] 476382K->392929K(932352K), 0.0080491 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 153478K->37688K(232960K)] 509665K->426908K(932352K), 0.0089527 secs] [Times: user=0.13 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 154119K->34395K(232960K)] 543338K->457443K(932352K), 0.0092237 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 151131K->40442K(232960K)] 574179K->493110K(932352K), 0.0086678 secs] [Times: user=0.14 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 157178K->37220K(232960K)] 609846K->525776K(932352K), 0.0087714 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 153956K->43436K(232960K)] 642512K->563658K(932352K), 0.0088811 secs] [Times: user=0.13 sys=0.02, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 160137K->35413K(232960K)] 680360K->594982K(932352K), 0.0086240 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 152149K->41923K(232960K)] 711718K->632628K(932352K), 0.0088387 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 158659K->43695K(232960K)] 749364K->673298K(932352K), 0.0101779 secs] [Times: user=0.05 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 160431K->30508K(232960K)] 790034K->697323K(932352K), 0.0094161 secs] [Times: user=0.05 sys=0.06, real=0.01 secs] 
[Full GC (Ergonomics) [PSYoungGen: 30508K->0K(232960K)] [ParOldGen: 666815K->363370K(699392K)] 697323K->363370K(932352K), [Metaspace: 3409K->3409K(1056768K)], 0.0553457 secs] [Times: user=0.33 sys=0.00, real=0.06 secs] 
[GC (Allocation Failure) [PSYoungGen: 116736K->44324K(232960K)] 480106K->407695K(932352K), 0.0092382 secs] [Times: user=0.09 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 161046K->41742K(239104K)] 524417K->444719K(938496K), 0.0111098 secs] [Times: user=0.11 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 166158K->44484K(234496K)] 569135K->484165K(933888K), 0.0103334 secs] [Times: user=0.09 sys=0.00, real=0.01 secs] 
[GC (Allocation Failure) [PSYoungGen: 168900K->42795K(248320K)] 608581K->520475K(947712K), 0.0096125 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
```

##### 堆内存布局情况

程序运行完退出之前，堆内存布局情况

```
执行结束!共生成对象次数:15918
Heap
 PSYoungGen      total 248320K, used 133825K [0x00000000eab00000, 0x0000000100000000, 0x0000000100000000)
  eden space 143360K, 63% used [0x00000000eab00000,0x00000000f03e5a08,0x00000000f3700000)
  from space 104960K, 40% used [0x00000000f9980000,0x00000000fc34acf8,0x0000000100000000)
  to   space 100864K, 0% used [0x00000000f3700000,0x00000000f3700000,0x00000000f9980000)
 ParOldGen       total 699392K, used 477680K [0x00000000c0000000, 0x00000000eab00000, 0x00000000eab00000)
  object space 699392K, 68% used [0x00000000c0000000,0x00000000dd27c168,0x00000000eab00000)
 Metaspace       used 3766K, capacity 4540K, committed 4864K, reserved 1056768K
  class space    used 416K, capacity 428K, committed 512K, reserved 1048576K

```

#### 打印GC日志-时间戳

`-XX:+PrintGCDateStamps`

`java -XX:+PrintGCDetails -XX:+PrintGCDateStamps  GCLogAnalysis`

在头部显示，上下对照看一下就懂啥意思了

`2022-05-14T23:04:03.845+0800`

 `【年-月-日】T【时-分-秒.毫秒】【东八区】`

##### GC执行过程

```
正在执行...
2022-05-14T23:04:03.845+0800: [GC (Allocation Failure) [PSYoungGen: 64512K->10751K(75264K)] 64512K->20379K(247296K), 0.0042903 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-14T23:04:03.864+0800: [GC (Allocation Failure) [PSYoungGen: 74992K->10747K(139776K)] 84621K->40284K(311808K), 0.0059999 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
2022-05-14T23:04:03.927+0800: [GC (Allocation Failure) [PSYoungGen: 139771K->10749K(139776K)] 169308K->82509K(311808K), 0.0136837 secs] [Times: user=0.05 sys=0.05, real=0.01 secs] 
2022-05-14T23:04:03.965+0800: [GC (Allocation Failure) [PSYoungGen: 139773K->10750K(268800K)] 211533K->120342K(440832K), 0.0092153 secs] [Times: user=0.06 sys=0.05, real=0.01 secs] 
2022-05-14T23:04:04.067+0800: [GC (Allocation Failure) [PSYoungGen: 268798K->10739K(268800K)] 378390K->192575K(451072K), 0.0145590 secs] [Times: user=0.02 sys=0.11, real=0.01 secs] 
2022-05-14T23:04:04.081+0800: [Full GC (Ergonomics) [PSYoungGen: 10739K->0K(268800K)] [ParOldGen: 181836K->158327K(317952K)] 192575K->158327K(586752K), [Metaspace: 3409K->3409K(1056768K)], 0.0249119 secs] [Times: user=0.13 sys=0.00, real=0.02 secs] 
2022-05-14T23:04:04.146+0800: [GC (Allocation Failure) [PSYoungGen: 258048K->86483K(537600K)] 416375K->244811K(855552K), 0.0173236 secs] [Times: user=0.05 sys=0.06, real=0.02 secs] 
2022-05-14T23:04:04.289+0800: [GC (Allocation Failure) [PSYoungGen: 537555K->104447K(587264K)] 695883K->342794K(905216K), 0.0309658 secs] [Times: user=0.08 sys=0.19, real=0.03 secs] 
2022-05-14T23:04:04.320+0800: [Full GC (Ergonomics) [PSYoungGen: 104447K->0K(587264K)] [ParOldGen: 238347K->268406K(471040K)] 342794K->268406K(1058304K), [Metaspace: 3409K->3409K(1056768K)], 0.0378687 secs] [Times: user=0.27 sys=0.05, real=0.04 secs] 
2022-05-14T23:04:04.428+0800: [GC (Allocation Failure) [PSYoungGen: 482145K->134581K(935936K)] 750551K->402987K(1406976K), 0.0270470 secs] [Times: user=0.05 sys=0.14, real=0.03 secs] 
2022-05-14T23:04:04.574+0800: [GC (Allocation Failure) [PSYoungGen: 907189K->179706K(952320K)] 1175595K->536219K(1423360K), 0.0508870 secs] [Times: user=0.13 sys=0.30, real=0.05 secs] 
2022-05-14T23:04:04.712+0800: [GC (Allocation Failure) [PSYoungGen: 952314K->244722K(1025024K)] 1308827K->639064K(1496064K), 0.0691034 secs] [Times: user=0.06 sys=0.48, real=0.07 secs] 
2022-05-14T23:04:04.781+0800: [Full GC (Ergonomics) [PSYoungGen: 244722K->0K(1025024K)] [ParOldGen: 394341K->365019K(594432K)] 639064K->365019K(1619456K), [Metaspace: 3751K->3751K(1056768K)], 0.0785147 secs] [Times: user=0.41 sys=0.02, real=0.08 secs] 

```

##### 堆内存布局情况

程序运行完退出之前，堆内存布局情况

```
执行结束!共生成对象次数:12701
Heap
 PSYoungGen      total 1025024K, used 31067K [0x000000076c000000, 0x00000007c0000000, 0x00000007c0000000)
  eden space 780288K, 3% used [0x000000076c000000,0x000000076de56ef0,0x000000079ba00000)
  from space 244736K, 0% used [0x00000007b1100000,0x00000007b1100000,0x00000007c0000000)
  to   space 297984K, 0% used [0x000000079ba00000,0x000000079ba00000,0x00000007add00000)
 ParOldGen       total 594432K, used 365019K [0x00000006c4000000, 0x00000006e8480000, 0x000000076c000000)
  object space 594432K, 61% used [0x00000006c4000000,0x00000006da476da0,0x00000006e8480000)
 Metaspace       used 3757K, capacity 4540K, committed 4864K, reserved 1056768K
  class space    used 416K, capacity 428K, committed 512K, reserved 1048576K

```

#### 打印GC日志-输出到文件

`-Xloggc:gc.demo.log`

`java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:gc.demo.log  GCLogAnalysis`

用文本编辑器打开查看

[![OgpYXF.png](https://s1.ax1x.com/2022/05/14/OgpYXF.png)](https://imgtu.com/i/OgpYXF)

### GC日志解释 

#### Young GC

```
2022-05-14T23:04:03.845+0800: [GC (Allocation Failure) [PSYoungGen: 64512K->10751K(75264K)] 64512K->20379K(247296K), 0.0042903 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
```

第一部分：`2022-05-14T23:04:03.845+0800`：时间戳，前面说过了

第二部分：`[GC (Allocation Failure) [PSYoungGen: 64512K->10751K(75264K)] 64512K->20379K(247296K), 0.0042903 secs]`：

`GC (Allocation Failure)`：GC（分配失败），GC的原因是内存分配失败导致的

`, 0.0042903 secs]` ：在`0.0042`秒内（GC暂停时间）

`[PSYoungGen: 64512K->10751K(75264K)]`：`young`区已经使用的内存大小从`64512K`变为了`10751K`，整个`young`区当前的最大的容量是

`75264K`

` 64512K->20379K(247296K)`：整个堆已经使用的内存从`64512K`变为了`20379K`，整个堆内存当前的最大的容量是`247296K`

第三部分：`[Times: user=0.00 sys=0.00, real=0.00 secs] `：CPU使用的时间

#### Full GC

```
2022-05-14T23:04:04.081+0800: [Full GC (Ergonomics) [PSYoungGen: 10739K->0K(268800K)] [ParOldGen: 181836K->158327K(317952K)] 192575K->158327K(586752K), [Metaspace: 3409K->3409K(1056768K)], 0.0249119 secs] [Times: user=0.13 sys=0.00, real=0.02 secs] 
```

`Full GC (Ergonomics)`：`Full GC`就是整个堆的`GC`，包括`young`区和`old`区

`[PSYoungGen: 10739K->0K(268800K)]`：`Full GC`的时候直接把young区清空

`[ParOldGen: 181836K->158327K(317952K)] 192575K->158327K(586752K)`：`old`区已经使用的内存从`181836K`压缩到`158327K`，`young`区清零，那么整体的堆内存也只使用了`158327K`

`[Metaspace: 3409K->3409K(1056768K)]`：元空间大小不变，不会GC

### GC的叫法

Young GC

Full GC（young gc + old gc）

或者叫

Minor GC（小型GC）

Major GC（大型GC）

因为`young`区一般情况下，整个内存比较少，存活对象也比较少，存放的都是些生命周期短的对象，新生的对象，所以处理的比较快，对于整个业务影响比较小，因此可以叫`Minor GC`

`Full GC`执行时间就比较长，影响比较大，可以叫`Major GC`

### 打印GC日志命令(配置GC策略)

#### 串行化GC策略

`-XX:+UseSerialGC`

`java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseSerialGC -Xmx1g -Xms1g GCLogAnalysis`

串行化其实就是单线程的，执行效率比较低，要等待前面的完成才能继续

比如下面的就是，前面都进行的是`youngGC`，`DefNew`是`young GC`，现在叫`DefNew`，之前叫`PSYoungGen`，都是youngGC，只是垃圾回收器的名字跟之前的不一样

`[DefNew: 279616K->34944K(314560K), 0.0467926 secs]`

直到最后，Old区比较大了，进行了一次Full GC，`Tenured`就是`Old GC`

`[Tenured: 626939K->383340K(699072K), 0.0817595 secs]`

```
正在执行...
2022-05-15T16:16:50.838+0800: [GC (Allocation Failure) [DefNew: 279616K->34944K(314560K), 0.0467926 secs] 279616K->87878K(1013632K), 0.0468248 secs] [Times: user=0.05 sys=0.00, real=0.05 secs] 
2022-05-15T16:16:50.930+0800: [GC (Allocation Failure) [DefNew: 314476K->34943K(314560K), 0.0619095 secs] 367411K->176999K(1013632K), 0.0619386 secs] [Times: user=0.02 sys=0.05, real=0.06 secs] 
2022-05-15T16:16:51.024+0800: [GC (Allocation Failure) [DefNew: 314559K->34943K(314560K), 0.0456862 secs] 456615K->259955K(1013632K), 0.0457058 secs] [Times: user=0.05 sys=0.00, real=0.05 secs] 
2022-05-15T16:16:51.110+0800: [GC (Allocation Failure) [DefNew: 314559K->34944K(314560K), 0.0454897 secs] 539571K->330778K(1013632K), 0.0455146 secs] [Times: user=0.03 sys=0.02, real=0.05 secs] 
2022-05-15T16:16:51.203+0800: [GC (Allocation Failure) [DefNew: 314332K->34943K(314560K), 0.0518000 secs] 610166K->413333K(1013632K), 0.0518284 secs] [Times: user=0.05 sys=0.00, real=0.05 secs] 
2022-05-15T16:16:51.300+0800: [GC (Allocation Failure) [DefNew: 314559K->34943K(314560K), 0.0444670 secs] 692949K->486593K(1013632K), 0.0444978 secs] [Times: user=0.00 sys=0.05, real=0.04 secs] 
2022-05-15T16:16:51.391+0800: [GC (Allocation Failure) [DefNew: 314559K->34943K(314560K), 0.0628492 secs] 766209K->574690K(1013632K), 0.0628828 secs] [Times: user=0.03 sys=0.03, real=0.06 secs] 
2022-05-15T16:16:51.502+0800: [GC (Allocation Failure) [DefNew: 314559K->34943K(314560K), 0.0554830 secs] 854306K->661883K(1013632K), 0.0555317 secs] [Times: user=0.00 sys=0.06, real=0.06 secs] 
2022-05-15T16:16:51.603+0800: [GC (Allocation Failure) [DefNew: 314559K->314559K(314560K), 0.0000208 secs][Tenured: 626939K->383340K(699072K), 0.0817595 secs] 941499K->383340K(1013632K), [Metaspace: 3409K->3409K(1056768K)], 0.0818163 secs] [Times: user=0.08 sys=0.00, real=0.08 secs] 
执行结束!共生成对象次数:10010
Heap
 def new generation   total 314560K, used 134996K [0x00000000c0000000, 0x00000000d5550000, 0x00000000d5550000)
  eden space 279616K,  48% used [0x00000000c0000000, 0x00000000c83d5290, 0x00000000d1110000)
  from space 34944K,   0% used [0x00000000d1110000, 0x00000000d1110000, 0x00000000d3330000)
  to   space 34944K,   0% used [0x00000000d3330000, 0x00000000d3330000, 0x00000000d5550000)
 tenured generation   total 699072K, used 383340K [0x00000000d5550000, 0x0000000100000000, 0x0000000100000000)
   the space 699072K,  54% used [0x00000000d5550000, 0x00000000ecbab0b8, 0x00000000ecbab200, 0x0000000100000000)
 Metaspace       used 3756K, capacity 4540K, committed 4864K, reserved 1056768K
  class space    used 416K, capacity 428K, committed 512K, reserved 1048576K

```

#### 并行GC策略（默认策略）

`-XX:+UseParallelGC`

你可以显示的指定

`java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseParallelGC -Xmx1g -Xms1g GCLogAnalysis`

也可以不写，默认会是并行GC策略（在jdk1.8是这样的）

`java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xmx1g -Xms1g GCLogAnalysis`

```
正在执行...
2022-05-15T16:51:03.523+0800: [GC (Allocation Failure) [PSYoungGen: 262144K->43516K(305664K)] 262144K->78444K(1005056K), 0.0146344 secs] [Times: user=0.03 sys=0.13, real=0.02 secs] 
2022-05-15T16:51:03.587+0800: [GC (Allocation Failure) [PSYoungGen: 305660K->43508K(305664K)] 340588K->146179K(1005056K), 0.0273709 secs] [Times: user=0.06 sys=0.11, real=0.03 secs] 
2022-05-15T16:51:03.663+0800: [GC (Allocation Failure) [PSYoungGen: 305652K->43504K(305664K)] 408323K->220823K(1005056K), 0.0238809 secs] [Times: user=0.02 sys=0.13, real=0.02 secs] 
2022-05-15T16:51:03.732+0800: [GC (Allocation Failure) [PSYoungGen: 305648K->43505K(305664K)] 482967K->298304K(1005056K), 0.0190840 secs] [Times: user=0.05 sys=0.11, real=0.02 secs] 
2022-05-15T16:51:03.797+0800: [GC (Allocation Failure) [PSYoungGen: 305387K->43519K(305664K)] 560185K->374300K(1005056K), 0.0189710 secs] [Times: user=0.11 sys=0.01, real=0.02 secs] 
2022-05-15T16:51:03.856+0800: [GC (Allocation Failure) [PSYoungGen: 305663K->43511K(160256K)] 636444K->443902K(859648K), 0.0191182 secs] [Times: user=0.02 sys=0.09, real=0.02 secs] 
2022-05-15T16:51:03.898+0800: [GC (Allocation Failure) [PSYoungGen: 159876K->70325K(232960K)] 560267K->477380K(932352K), 0.0096994 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
2022-05-15T16:51:03.922+0800: [GC (Allocation Failure) [PSYoungGen: 187061K->91303K(232960K)] 594116K->505867K(932352K), 0.0130428 secs] [Times: user=0.14 sys=0.00, real=0.01 secs] 
2022-05-15T16:51:03.954+0800: [GC (Allocation Failure) [PSYoungGen: 208039K->104541K(232960K)] 622603K->535654K(932352K), 0.0154485 secs] [Times: user=0.11 sys=0.02, real=0.02 secs] 
2022-05-15T16:51:03.987+0800: [GC (Allocation Failure) [PSYoungGen: 221197K->79433K(232960K)] 652309K->569385K(932352K), 0.0222945 secs] [Times: user=0.22 sys=0.05, real=0.02 secs] 
2022-05-15T16:51:04.032+0800: [GC (Allocation Failure) [PSYoungGen: 196133K->40884K(232960K)] 686086K->601904K(932352K), 0.0182937 secs] [Times: user=0.09 sys=0.05, real=0.02 secs] 
2022-05-15T16:51:04.071+0800: [GC (Allocation Failure) [PSYoungGen: 157335K->38968K(232960K)] 718354K->637431K(932352K), 0.0170473 secs] [Times: user=0.11 sys=0.03, real=0.02 secs] 
2022-05-15T16:51:04.089+0800: [Full GC (Ergonomics) [PSYoungGen: 38968K->0K(232960K)] [ParOldGen: 598462K->331369K(699392K)] 637431K->331369K(932352K), [Metaspace: 3409K->3409K(1056768K)], 0.0541838 secs] [Times: user=0.38 sys=0.00, real=0.05 secs] 
2022-05-15T16:51:04.169+0800: [GC (Allocation Failure) [PSYoungGen: 116736K->39501K(232960K)] 448105K->370871K(932352K), 0.0049644 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
2022-05-15T16:51:04.189+0800: [GC (Allocation Failure) [PSYoungGen: 156237K->38804K(232960K)] 487607K->404937K(932352K), 0.0103109 secs] [Times: user=0.13 sys=0.00, real=0.01 secs] 
2022-05-15T16:51:04.218+0800: [GC (Allocation Failure) [PSYoungGen: 155487K->39853K(232960K)] 521620K->442800K(932352K), 0.0100154 secs] [Times: user=0.14 sys=0.00, real=0.01 secs] 
2022-05-15T16:51:04.245+0800: [GC (Allocation Failure) [PSYoungGen: 156589K->36590K(232960K)] 559536K->474987K(932352K), 0.0098695 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
2022-05-15T16:51:04.274+0800: [GC (Allocation Failure) [PSYoungGen: 153326K->38826K(232960K)] 591723K->508437K(932352K), 0.0117961 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
2022-05-15T16:51:04.314+0800: [GC (Allocation Failure) [PSYoungGen: 155562K->36112K(232960K)] 625173K->541531K(932352K), 0.0107636 secs] [Times: user=0.16 sys=0.00, real=0.01 secs] 
2022-05-15T16:51:04.350+0800: [GC (Allocation Failure) [PSYoungGen: 152848K->47432K(232960K)] 658267K->584391K(932352K), 0.0111859 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
2022-05-15T16:51:04.383+0800: [GC (Allocation Failure) [PSYoungGen: 164168K->42272K(232960K)] 701127K->620642K(932352K), 0.0100760 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
执行结束!共生成对象次数:12246
Heap
 PSYoungGen      total 232960K, used 105658K [0x00000000eab00000, 0x0000000100000000, 0x0000000100000000)
  eden space 116736K, 54% used [0x00000000eab00000,0x00000000ee8e6640,0x00000000f1d00000)
  from space 116224K, 36% used [0x00000000f8e80000,0x00000000fb7c8258,0x0000000100000000)
  to   space 116224K, 0% used [0x00000000f1d00000,0x00000000f1d00000,0x00000000f8e80000)
 ParOldGen       total 699392K, used 578370K [0x00000000c0000000, 0x00000000eab00000, 0x00000000eab00000)
  object space 699392K, 82% used [0x00000000c0000000,0x00000000e34d08e8,0x00000000eab00000)
 Metaspace       used 3766K, capacity 4540K, committed 4864K, reserved 1056768K
  class space    used 416K, capacity 428K, committed 512K, reserved 1048576K

```



#### 小`Tips`：

默认是打开自适应参数的，你可以看到 `young` 的内存大小是在不断变化的，其实堆内存的大小也是在不断变化的，jvm会动态的根据算法

调整各种容量的大小还有一些其他的参数，比如：

`-XX:+MaxTenuringThreshold=15`

晋升到`Old`区，默认是15，也就是youngGC 15次还没有被回收，就晋升到`Old`区，但是你开了自适应参数就不一定多少次了



#### 如果不设置`Xms`会怎样？

`java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseParallelGC -Xmx1g GCLogAnalysis`

不设置`Xms1g`，相对于设置`Xms1g`，会多发生Full GC

不设置`Xms1g`，可能就用了500MB的堆内存，等垃圾足够多了，Old区足够大，就要Full GC，然后堆内存会增大直到1g,也就是`-Xmx1g`

设置`Xms1g`，上来就分配了1g堆内存，相当于给了个大蓄水池肯定Full GC的次数少

#### CMS GC策略

`-XX:+UseConcMarkSweepGC`

`java -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+UseConcMarkSweepGC -Xmx1g -Xms1g GCLogAnalysis`

阶段 1：Initial Mark（初始标记）

阶段 2：Concurrent Mark（并发标记）

阶段 3：Concurrent Preclean（并发预清理）

阶段 4： Final Remark（最终标记）

阶段 5： Concurrent Sweep（并发清除）

阶段 6： Concurrent Reset（并发重置）

1、4是需要STW（stop-the-world GC暂停）

```
正在执行...
2022-05-15T22:45:52.185+0800: [GC (Allocation Failure) [ParNew: 279616K->34942K(314560K), 0.0130584 secs] 279616K->76588K(1013632K), 0.0131004 secs] [Times: user=0.08 sys=0.08, real=0.01 secs] 
2022-05-15T22:45:52.241+0800: [GC (Allocation Failure) [ParNew: 314558K->34944K(314560K), 0.0182366 secs] 356204K->153252K(1013632K), 0.0182710 secs] [Times: user=0.03 sys=0.13, real=0.02 secs] 
2022-05-15T22:45:52.296+0800: [GC (Allocation Failure) [ParNew: 314560K->34942K(314560K), 0.0413536 secs] 432868K->232371K(1013632K), 0.0413799 secs] [Times: user=0.28 sys=0.05, real=0.04 secs] 
2022-05-15T22:45:52.374+0800: [GC (Allocation Failure) [ParNew: 314352K->34942K(314560K), 0.0424765 secs] 511781K->315380K(1013632K), 0.0425006 secs] [Times: user=0.33 sys=0.05, real=0.04 secs] 
2022-05-15T22:45:52.449+0800: [GC (Allocation Failure) [ParNew: 314548K->34937K(314560K), 0.0376644 secs] 594986K->389169K(1013632K), 0.0376864 secs] [Times: user=0.28 sys=0.01, real=0.04 secs] 
2022-05-15T22:45:52.486+0800: [GC (CMS Initial Mark) [1 CMS-initial-mark: 354232K(699072K)] 389384K(1013632K), 0.0002410 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.487+0800: [CMS-concurrent-mark-start]
2022-05-15T22:45:52.489+0800: [CMS-concurrent-mark: 0.002/0.002 secs] [Times: user=0.06 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.489+0800: [CMS-concurrent-preclean-start]
2022-05-15T22:45:52.490+0800: [CMS-concurrent-preclean: 0.001/0.001 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.490+0800: [CMS-concurrent-abortable-preclean-start]
2022-05-15T22:45:52.531+0800: [GC (Allocation Failure) [ParNew: 314544K->34942K(314560K), 0.0381142 secs] 668777K->464352K(1013632K), 0.0381355 secs] [Times: user=0.36 sys=0.02, real=0.04 secs] 
2022-05-15T22:45:52.598+0800: [GC (Allocation Failure) [ParNew: 314558K->34943K(314560K), 0.0363172 secs] 743968K->539079K(1013632K), 0.0363379 secs] [Times: user=0.38 sys=0.03, real=0.04 secs] 
2022-05-15T22:45:52.664+0800: [GC (Allocation Failure) [ParNew: 314559K->34942K(314560K), 0.0425707 secs] 818695K->623850K(1013632K), 0.0425922 secs] [Times: user=0.30 sys=0.02, real=0.04 secs] 
2022-05-15T22:45:52.735+0800: [GC (Allocation Failure) [ParNew: 314445K->34943K(314560K), 0.0392278 secs] 903352K->693869K(1013632K), 0.0392499 secs] [Times: user=0.34 sys=0.03, real=0.04 secs] 
2022-05-15T22:45:52.775+0800: [CMS-concurrent-abortable-preclean: 0.008/0.285 secs] [Times: user=1.50 sys=0.09, real=0.29 secs] 
2022-05-15T22:45:52.776+0800: [GC (CMS Final Remark) [YG occupancy: 46614 K (314560 K)][Rescan (parallel) , 0.0004319 secs][weak refs processing, 0.0000119 secs][class unloading, 0.0002379 secs][scrub symbol table, 0.0004234 secs][scrub string table, 0.0000855 secs][1 CMS-remark: 658925K(699072K)] 705539K(1013632K), 0.0012712 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.777+0800: [CMS-concurrent-sweep-start]
2022-05-15T22:45:52.779+0800: [CMS-concurrent-sweep: 0.002/0.002 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.779+0800: [CMS-concurrent-reset-start]
2022-05-15T22:45:52.780+0800: [CMS-concurrent-reset: 0.001/0.001 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.805+0800: [GC (Allocation Failure) [ParNew: 314559K->34943K(314560K), 0.0213354 secs] 856124K->658458K(1013632K), 0.0213558 secs] [Times: user=0.13 sys=0.00, real=0.02 secs] 
2022-05-15T22:45:52.827+0800: [GC (CMS Initial Mark) [1 CMS-initial-mark: 623514K(699072K)] 658705K(1013632K), 0.0001553 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.827+0800: [CMS-concurrent-mark-start]
2022-05-15T22:45:52.828+0800: [CMS-concurrent-mark: 0.001/0.001 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.828+0800: [CMS-concurrent-preclean-start]
2022-05-15T22:45:52.829+0800: [CMS-concurrent-preclean: 0.001/0.001 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.829+0800: [CMS-concurrent-abortable-preclean-start]
2022-05-15T22:45:52.860+0800: [GC (Allocation Failure) [ParNew: 314559K->314559K(314560K), 0.0000150 secs][CMS2022-05-15T22:45:52.860+0800: [CMS-concurrent-abortable-preclean: 0.001/0.031 secs] [Times: user=0.03 sys=0.00, real=0.03 secs] 
 (concurrent mode failure): 623514K->363267K(699072K), 0.0615289 secs] 938074K->363267K(1013632K), [Metaspace: 3409K->3409K(1056768K)], 0.0615768 secs] [Times: user=0.06 sys=0.00, real=0.06 secs] 
2022-05-15T22:45:52.952+0800: [GC (Allocation Failure) [ParNew: 279616K->34942K(314560K), 0.0169921 secs] 642883K->451792K(1013632K), 0.0170164 secs] [Times: user=0.13 sys=0.00, real=0.02 secs] 
2022-05-15T22:45:52.969+0800: [GC (CMS Initial Mark) [1 CMS-initial-mark: 416849K(699072K)] 451869K(1013632K), 0.0002022 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.969+0800: [CMS-concurrent-mark-start]
2022-05-15T22:45:52.970+0800: [CMS-concurrent-mark: 0.001/0.001 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.970+0800: [CMS-concurrent-preclean-start]
2022-05-15T22:45:52.971+0800: [CMS-concurrent-preclean: 0.001/0.001 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
2022-05-15T22:45:52.971+0800: [CMS-concurrent-abortable-preclean-start]
2022-05-15T22:45:53.004+0800: [GC (Allocation Failure) [ParNew: 314299K->34943K(314560K), 0.0221347 secs] 731149K->531003K(1013632K), 0.0221571 secs] [Times: user=0.31 sys=0.00, real=0.02 secs] 
2022-05-15T22:45:53.063+0800: [GC (Allocation Failure) [ParNew: 314559K->34942K(314560K), 0.0173637 secs] 810619K->604717K(1013632K), 0.0173832 secs] [Times: user=0.16 sys=0.00, real=0.02 secs] 
执行结束!共生成对象次数:14511
Heap
 par new generation   total 314560K, used 43638K [0x00000000c0000000, 0x00000000d5550000, 0x00000000d5550000)
  eden space 279616K,   3% used [0x00000000c0000000, 0x00000000c087e170, 0x00000000d1110000)
  from space 34944K,  99% used [0x00000000d3330000, 0x00000000d554f9b8, 0x00000000d5550000)
  to   space 34944K,   0% used [0x00000000d1110000, 0x00000000d1110000, 0x00000000d3330000)
 concurrent mark-sweep generation total 699072K, used 569774K [0x00000000d5550000, 0x0000000100000000, 0x0000000100000000)
 Metaspace       used 3766K, capacity 4540K, committed 4864K, reserved 1056768K
  class space    used 416K, capacity 428K, committed 512K, reserved 1048576K

```

#### G1 GC策略

`-XX:+UseG1GC`

`java -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+UseG1GC -Xmx1g -Xms1g GCLogAnalysis`

`-XX:+PrintGC`可以看的更简洁一些



Evacuation Pause: young（纯年轻代模式转移暂停）

Concurrent Marking（并发标记）

阶段 1: Initial Mark（初始标记）

阶段 2: Root Region Scan（Root区扫描）

阶段 3: Concurrent Mark（并发标记）

阶段 4: Remark（再次标记）

阶段 5: Cleanup（清理）

Evacuation Pause (mixed)（转移暂停: 混合模式）

Full GC (Allocation Failure)

```
正在执行...
2022-05-15T23:13:28.368+0800: [GC pause (G1 Evacuation Pause) (young) 68M->30M(1024M), 0.0043053 secs]
2022-05-15T23:13:28.385+0800: [GC pause (G1 Evacuation Pause) (young) 84M->48M(1024M), 0.0035740 secs]
2022-05-15T23:13:28.404+0800: [GC pause (G1 Evacuation Pause) (young) 111M->69M(1024M), 0.0045385 secs]
2022-05-15T23:13:28.428+0800: [GC pause (G1 Evacuation Pause) (young) 152M->104M(1024M), 0.0054432 secs]
2022-05-15T23:13:28.452+0800: [GC pause (G1 Evacuation Pause) (young) 197M->142M(1024M), 0.0062605 secs]
2022-05-15T23:13:28.480+0800: [GC pause (G1 Evacuation Pause) (young) 251M->186M(1024M), 0.0073969 secs]
2022-05-15T23:13:28.525+0800: [GC pause (G1 Evacuation Pause) (young) 348M->247M(1024M), 0.0088610 secs]
2022-05-15T23:13:28.569+0800: [GC pause (G1 Evacuation Pause) (young) 434M->311M(1024M), 0.0086066 secs]
2022-05-15T23:13:28.666+0800: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 680M->417M(1024M), 0.0151913 secs]
2022-05-15T23:13:28.681+0800: [GC concurrent-root-region-scan-start]
2022-05-15T23:13:28.682+0800: [GC concurrent-root-region-scan-end, 0.0003142 secs]
2022-05-15T23:13:28.682+0800: [GC concurrent-mark-start]
2022-05-15T23:13:28.683+0800: [GC concurrent-mark-end, 0.0016731 secs]
2022-05-15T23:13:28.683+0800: [GC remark, 0.0015018 secs]
2022-05-15T23:13:28.685+0800: [GC cleanup 436M->387M(1024M), 0.0006048 secs]
2022-05-15T23:13:28.686+0800: [GC concurrent-cleanup-start]
2022-05-15T23:13:28.686+0800: [GC concurrent-cleanup-end, 0.0000449 secs]
2022-05-15T23:13:28.718+0800: [GC pause (G1 Evacuation Pause) (young) 635M->442M(1024M), 0.0143636 secs]
2022-05-15T23:13:28.735+0800: [GC pause (G1 Evacuation Pause) (mixed) 462M->398M(1024M), 0.0075846 secs]
2022-05-15T23:13:28.747+0800: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 427M->408M(1024M), 0.0022425 secs]
2022-05-15T23:13:28.749+0800: [GC concurrent-root-region-scan-start]
2022-05-15T23:13:28.749+0800: [GC concurrent-root-region-scan-end, 0.0001284 secs]
2022-05-15T23:13:28.749+0800: [GC concurrent-mark-start]
2022-05-15T23:13:28.750+0800: [GC concurrent-mark-end, 0.0011262 secs]
2022-05-15T23:13:28.751+0800: [GC remark, 0.0011737 secs]
2022-05-15T23:13:28.752+0800: [GC cleanup 416M->393M(1024M), 0.0007402 secs]
2022-05-15T23:13:28.753+0800: [GC concurrent-cleanup-start]
2022-05-15T23:13:28.753+0800: [GC concurrent-cleanup-end, 0.0000423 secs]
2022-05-15T23:13:28.823+0800: [GC pause (G1 Evacuation Pause) (young)-- 840M->561M(1024M), 0.0120947 secs]
2022-05-15T23:13:28.836+0800: [GC pause (G1 Evacuation Pause) (mixed) 569M->521M(1024M), 0.0090624 secs]
2022-05-15T23:13:28.845+0800: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 521M->521M(1024M), 0.0012768 secs]
2022-05-15T23:13:28.847+0800: [GC concurrent-root-region-scan-start]
2022-05-15T23:13:28.847+0800: [GC concurrent-root-region-scan-end, 0.0001265 secs]
2022-05-15T23:13:28.847+0800: [GC concurrent-mark-start]
2022-05-15T23:13:28.848+0800: [GC concurrent-mark-end, 0.0014238 secs]
2022-05-15T23:13:28.848+0800: [GC remark, 0.0015889 secs]
2022-05-15T23:13:28.850+0800: [GC cleanup 530M->487M(1024M), 0.0005994 secs]
2022-05-15T23:13:28.851+0800: [GC concurrent-cleanup-start]
2022-05-15T23:13:28.851+0800: [GC concurrent-cleanup-end, 0.0000367 secs]
2022-05-15T23:13:28.893+0800: [GC pause (G1 Evacuation Pause) (young) 824M->588M(1024M), 0.0105658 secs]
2022-05-15T23:13:28.906+0800: [GC pause (G1 Evacuation Pause) (mixed) 608M->502M(1024M), 0.0069509 secs]
2022-05-15T23:13:28.921+0800: [GC pause (G1 Evacuation Pause) (mixed) 557M->484M(1024M), 0.0050978 secs]
2022-05-15T23:13:28.926+0800: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 484M->484M(1024M), 0.0014747 secs]
2022-05-15T23:13:28.927+0800: [GC concurrent-root-region-scan-start]
2022-05-15T23:13:28.927+0800: [GC concurrent-root-region-scan-end, 0.0001260 secs]
2022-05-15T23:13:28.927+0800: [GC concurrent-mark-start]
2022-05-15T23:13:28.929+0800: [GC concurrent-mark-end, 0.0012525 secs]
2022-05-15T23:13:28.929+0800: [GC remark, 0.0013601 secs]
2022-05-15T23:13:28.930+0800: [GC cleanup 493M->456M(1024M), 0.0006728 secs]
2022-05-15T23:13:28.931+0800: [GC concurrent-cleanup-start]
2022-05-15T23:13:28.931+0800: [GC concurrent-cleanup-end, 0.0000512 secs]
2022-05-15T23:13:28.989+0800: [GC pause (G1 Evacuation Pause) (young) 822M->565M(1024M), 0.0143520 secs]
2022-05-15T23:13:29.006+0800: [GC pause (G1 Evacuation Pause) (mixed) 580M->494M(1024M), 0.0110774 secs]
2022-05-15T23:13:29.029+0800: [GC pause (G1 Evacuation Pause) (mixed) 550M->511M(1024M), 0.0035109 secs]
2022-05-15T23:13:29.033+0800: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 514M->511M(1024M), 0.0018920 secs]
2022-05-15T23:13:29.035+0800: [GC concurrent-root-region-scan-start]
2022-05-15T23:13:29.036+0800: [GC concurrent-root-region-scan-end, 0.0001916 secs]
2022-05-15T23:13:29.036+0800: [GC concurrent-mark-start]
2022-05-15T23:13:29.037+0800: [GC concurrent-mark-end, 0.0017090 secs]
2022-05-15T23:13:29.037+0800: [GC remark, 0.0012526 secs]
2022-05-15T23:13:29.039+0800: [GC cleanup 521M->479M(1024M), 0.0006971 secs]
2022-05-15T23:13:29.039+0800: [GC concurrent-cleanup-start]
2022-05-15T23:13:29.040+0800: [GC concurrent-cleanup-end, 0.0000616 secs]
2022-05-15T23:13:29.084+0800: [GC pause (G1 Evacuation Pause) (young) 818M->575M(1024M), 0.0102697 secs]
2022-05-15T23:13:29.098+0800: [GC pause (G1 Evacuation Pause) (mixed) 596M->509M(1024M), 0.0089840 secs]
2022-05-15T23:13:29.116+0800: [GC pause (G1 Evacuation Pause) (mixed) 571M->526M(1024M), 0.0044905 secs]
2022-05-15T23:13:29.121+0800: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 530M->527M(1024M), 0.0015303 secs]
2022-05-15T23:13:29.123+0800: [GC concurrent-root-region-scan-start]
2022-05-15T23:13:29.123+0800: [GC concurrent-root-region-scan-end, 0.0001470 secs]
2022-05-15T23:13:29.123+0800: [GC concurrent-mark-start]
2022-05-15T23:13:29.125+0800: [GC concurrent-mark-end, 0.0017913 secs]
2022-05-15T23:13:29.125+0800: [GC remark, 0.0012582 secs]
2022-05-15T23:13:29.127+0800: [GC cleanup 541M->495M(1024M), 0.0007066 secs]
2022-05-15T23:13:29.127+0800: [GC concurrent-cleanup-start]
2022-05-15T23:13:29.127+0800: [GC concurrent-cleanup-end, 0.0000934 secs]
2022-05-15T23:13:29.169+0800: [GC pause (G1 Evacuation Pause) (young) 798M->590M(1024M), 0.0109386 secs]
2022-05-15T23:13:29.183+0800: [GC pause (G1 Evacuation Pause) (mixed) 616M->527M(1024M), 0.0092043 secs]
2022-05-15T23:13:29.200+0800: [GC pause (G1 Evacuation Pause) (mixed) 582M->535M(1024M), 0.0045733 secs]
2022-05-15T23:13:29.206+0800: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 542M->538M(1024M), 0.0019523 secs]
2022-05-15T23:13:29.208+0800: [GC concurrent-root-region-scan-start]
2022-05-15T23:13:29.208+0800: [GC concurrent-root-region-scan-end, 0.0002354 secs]
2022-05-15T23:13:29.208+0800: [GC concurrent-mark-start]
2022-05-15T23:13:29.210+0800: [GC concurrent-mark-end, 0.0021730 secs]
2022-05-15T23:13:29.211+0800: [GC remark, 0.0013315 secs]
2022-05-15T23:13:29.213+0800: [GC cleanup 552M->511M(1024M), 0.0007478 secs]
2022-05-15T23:13:29.213+0800: [GC concurrent-cleanup-start]
2022-05-15T23:13:29.213+0800: [GC concurrent-cleanup-end, 0.0000852 secs]
2022-05-15T23:13:29.254+0800: [GC pause (G1 Evacuation Pause) (young) 772M->578M(1024M), 0.0106511 secs]
2022-05-15T23:13:29.268+0800: [GC pause (G1 Evacuation Pause) (mixed) 607M->518M(1024M), 0.0098437 secs]
2022-05-15T23:13:29.284+0800: [GC pause (G1 Evacuation Pause) (mixed) 575M->522M(1024M), 0.0057352 secs]
2022-05-15T23:13:29.291+0800: [GC pause (G1 Humongous Allocation) (young) (initial-mark) 525M->524M(1024M), 0.0021817 secs]
2022-05-15T23:13:29.293+0800: [GC concurrent-root-region-scan-start]
2022-05-15T23:13:29.293+0800: [GC concurrent-root-region-scan-end, 0.0001115 secs]
2022-05-15T23:13:29.293+0800: [GC concurrent-mark-start]
2022-05-15T23:13:29.294+0800: [GC concurrent-mark-end, 0.0013354 secs]
2022-05-15T23:13:29.294+0800: [GC remark, 0.0012183 secs]
2022-05-15T23:13:29.296+0800: [GC cleanup 537M->502M(1024M), 0.0005539 secs]
2022-05-15T23:13:29.296+0800: [GC concurrent-cleanup-start]
2022-05-15T23:13:29.296+0800: [GC concurrent-cleanup-end, 0.0000330 secs]
执行结束!共生成对象次数:15500
```



# 第二题

使用压测工具（wrk 或 sb），演练 gateway-server-0.0.1-SNAPSHOT.jar 示例。

> 详细参数请参考：https://blog.csdn.net/qishuzdh/article/details/124871723

```

## Windows

1.管理员身份打开powershell

2.运行
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

3.执行choco install superbenchmarker

4.输入 sb

执行 sb -u http://localhost:8088/api/hello -c 20 -N 60

## Mac

1.执行brew install wrk
如果显式brew update很慢，可以ctrl+C打断更新

2.输入 wrk

执行 wrk -t8 -c40 -d60s http://localhost:8088/api/hello

## 压测程序

1.可以从github获取
git clone https://github.com/kimmking/atlantis
cd atlantis\gateway-server
mvn clean package
然后在target目录可以找到gateway-server-0.0.1-SNAPSHOT.jar

2.也可以从此处下载已经编译好的：
链接：https://pan.baidu.com/s/1NbpYX4M3YKLYM1JJeIzgSQ 
提取码：sp85 

java -jar -Xmx512m -Xms512m gateway-server-0.0.1-SNAPSHOT.jar


```



[![XA3ede.png](https://s1.ax1x.com/2022/05/25/XA3ede.png)](https://imgtu.com/i/XA3ede)

# 第四题

根据上述自己对于 1 和 2 的演示，写一段对于不同 GC 和堆内存的总结

**串行GC：**

单线程垃圾收集器，不能进行并行处理，会触发STW，停止所有应用线程。

这种GC算法不能充分利用到多核CPU的优势，在垃圾收集时只能使用单个核心。只适合堆内存不大的JVM，而且是单核CPU场景，比方说客户端应用。

**并行GC：**

多个GC线程并行执行，大幅减少GC时间

适用于多核服务器，目标是增加吞吐量。GC期间，所有线程都并行做GC，所以业务暂停时间更短。两次GC间隔期间，不会有线程执行GC，不消耗任何资源

**CMS：**

主要并发-标记-清除垃圾收集器。

1、不对老年代进行整理（compact），使用空闲列表管理内存空间回收。
2、在标记-清除阶段的大部分工作与应用线程并发。

通过以上两点避免老年代GC时间长。服务器为多核，且需要降低延迟，可选择CMS；但由于多数时间GC线程和业务线程并行，所以CMS的吞吐量会比ParallelGC差。

CMS的GC线程会和应用线程抢CPU时间，默认情况CMS使用内核数1/4的并发线程。

CMS最大的问题就是老年代内存的碎片问题，因为他没整理

**G1:**

垃圾优先算法。

1、可以设置性能指标，指定在任意时间内，STW的时间不超过多少毫秒

2、堆内存划分成多个可存放对象的小区块，每个小区块可能是Eden区，可能是Survivor区，也可能是old区，只有逻辑上的年轻代和老年代

3、并发阶段估算每个小区块存活对象的总数，构建回收集（collection set），原则是垃圾最多的小区块会被最先收集–Garbage First









